<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ScTurtle's Pool  - Genetic Algorithm and Image Evolution </title>
    <link rel="shortcut icon" href="../images/favicon.png">
    <link rel="stylesheet" type="text/css" href="../asserts/default.css">
    <link rel="stylesheet" type="text/css" href="../asserts/highlight.css">
    <script src="../asserts/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link href="../atom.xml" rel="alternate" title="ScTurtle's Pool" type="application/atom+xml">
  </head>
  <body>
    <div id="header">
      <div id="logo">
        <a href="../">ScTurtle's Pool</a>
      </div>
      <div id="navigation">
        <a href="../">Home</a>
        <a href="../archive.html">Archive</a>
        <a href="../tags.html">Tags</a>
        <a href="../about.html">About</a>
      </div>
    </div>

    <div id="content">
      <h1>Genetic Algorithm and Image Evolution</h1>
      <div class="info">
  Posted on April 18, 2014
   on <a href="../tags/algo.html">algo</a>, <a href="../tags/python.html">python</a> 
</div>

<p style="text-align: center;">
<img src="../images/ga-original.png" style="display:inline" /> <img src="../images/ga-result.bmp" style="display:inline" />
</p>
<p>Recently, I find a <a href="http://multigrad.blogspot.hk/2014/04/math-evolution-and-dirty-tricks.html">blog</a> about how to use <a href="https://code.google.com/p/deap/">DEAP</a>, a genetic programming library in Python, to find the magic number in the famous <a href="http://en.wikipedia.org/wiki/Fast_inverse_square_root">fast inverse square root</a> algorithm. It seems that genetic algorithm is not too difficult and let’s play it on an <a href="http://rogeralsing.com/2008/12/07/genetic-programming-evolution-of-mona-lisa/">old toy programming game</a>.</p>
<p>The purpose is to use a certain number of triangles to approximate an image. A lot of works have been done on this in various programming languages. But let’s try it by hand and in Python.</p>
<p>The idea of genetic algorithm is repeatedly evolution on a population of DNA. Good DNA are kept and used to generate the next generation through crossover and mutation. In plain words, crossover is exchanging small parts between two DNA and mutation is random change on one DNA.</p>
<p>First, we need to import something:</p>
<div class="highlight"><pre><code class="python">from deap import base, creator, tools, algorithms
from PIL import Image, ImageDraw
...</code></pre></div>
<p>Let’s fix some constants. The size of image is restricted to be 100x100. Each generation contains a population of 40 individuals. And the DNA of each individual is just a set of 50 triangles.</p>
<div class="highlight"><pre><code class="python">PIC = Image.open('head.jpg')
SIZE = 100
NUMBER_OF_TRIANGLES = 50
POPULATION = 40
NGEN = 10000
POLY = 3</code></pre></div>
<p>We need <code>gen_one_triangle()</code> to generate one triangle in random position with random color and transparency.</p>
<div class="highlight"><pre><code class="python">def gen_one_triangle():
    return (tuple([(randint(0, SIZE), randint(0, SIZE)) for i in xrange(POLY)]),
            randint(0,255), randint(0,255), randint(0,255), randint(0,30))</code></pre></div>
<p>With DEAP, we define some classes and the initial part:</p>
<div class="highlight"><pre><code class="python">creator.create("Fitness", base.Fitness, weights=(1.0,))  # maximize fitness
creator.create("Individual", list, fitness=creator.Fitness)  # individual class

toolbox = base.Toolbox()
toolbox.register("attr", gen_one_triangle)  # the above function
toolbox.register("individual", tools.initRepeat,  # initialization of individual
                 creator.Individual, toolbox.attr, NUMBER_OF_TRIANGLES)
toolbox.register("population", tools.initRepeat,  # initialization of population
                 list, toolbox.individual)</code></pre></div>
<p>Now we should figure out how to evaluate the intermediate result (50 triangles). I draw them on an blank background and do pixel by pixel comparison with the origin image:</p>
<div class="highlight"><pre><code class="python">def triangles_to_image(triangles):
    im = Image.new('RGB', (SIZE, SIZE), (255, 255, 255))
    for tri in triangles:
        mask = Image.new('RGBA', (SIZE, SIZE))
        draw = ImageDraw.Draw(mask)
        draw.polygon(tri[0], fill=tri[1:])
        im.paste(mask, mask=mask)
        del mask, draw
    return im

def evaluate(im1, t2):
    im2 = triangles_to_image(t2)
    pix1, pix2 = im1.load(), im2.load()
    ans = 0
    for i in xrange(SIZE):
        for j in xrange(SIZE):
            a1, a2, a3 = pix1[i, j]
            b1, b2, b3 = pix2[i, j]
            ans += (a1 - b1) ** 2 + (a2 - b2) ** 2 + (a3 - b3) ** 2
    return 1 - (1. * sqrt(ans) / sqrt(SIZE * SIZE * 3 * 255 * 255)),

toolbox.register("evaluate", partial(evaluate, PIC))</code></pre></div>
<p>For crossover we use the default function in DEAP to work on sequences. And we define a <code>mutate</code> function to change position or color of one triangle in individual. (That function is a bit long and boring. Let’s skip it …) We also use the default select function in DEAP. Register them:</p>
<div class="highlight"><pre><code class="python">toolbox.register("evaluate", partial(evaluate, PIC))
toolbox.register("mate", tools.cxTwoPoint)  # crossover
toolbox.register("mutate", mutate)  # mutation
toolbox.register("select", tools.selTournament, tournsize=3)</code></pre></div>
<p>Finally, in the <code>main</code> function we just call the algorithm function in one line.</p>
<div class="highlight"><pre><code class="python">def main():
    pop = toolbox.population(n=POPULATION)
    hof = tools.HallOfFame(1)

    stats = tools.Statistics(lambda ind: ind.fitness.values)
    stats.register("std", numpy.std)
    stats.register("max", numpy.max)
    stats.register("avg", numpy.mean)
    stats.register("min", numpy.min)

    try:
        pop, log = algorithms.eaSimple(
            pop, toolbox, cxpb=0.5, mutpb=0.1, ngen=NGEN, stats=stats,
            halloffame=hof, verbose=True)
    finally:
        open('result.txt', 'w').write(repr(hof[0]))
        triangles_to_image(hof[0]).save('result.bmp')</code></pre></div>
<p>The picture in the head of this blog is generated through 10,000 generations within sevaral hours.<br />
The full source code is <a href="https://gist.github.com/scturtle/11035675">here</a>. Feel free to play with it.</p>

<div id="show_disqus">
  <a onclick="load_disqus();return false;" href="##">Show comments</a>
</div>
<div id="disqus_thread"></div>

<script type="text/javascript">
  function load_disqus() {
    var disqus_shortname = 'scturtlespool';
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    document.getElementById('show_disqus').style.display='none';
  };
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script>

    </div>
    <div id="footer">
      <p><a href="https://github.com/scturtle/turtlepool">turtlepool</a> &copy;
        <script>document.write(new Date().getFullYear());</script> scturtle
      <p> <a href="mailto:scturtle@gmail.com">mail</a>,
        <a href="https://twitter.com/scturtle">twitter</a>,
        <a href="https://github.com/scturtle">github</a>,
        <a href="../atom.xml" rel="alternate" title="Recent Blogs | ScTurtle's Pool">feed</a>
    </div>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33410961-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
  </body>
</html>
