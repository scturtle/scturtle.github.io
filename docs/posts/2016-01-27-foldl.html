<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Exploring Writing foldl Using foldr | turtleblog</title>
<link rel="stylesheet" href="/scss/main.min.1ba4542362e054b04dcc1f2b7adad1e43300c04288cbb3353f53042bc5dd86b3.css" integrity="sha256-G6RUI2LgVLBNzB8retrR5DMAwEKIy7M1P1MEK8XdhrM=">

</head>
<body>
<main>
<header>
<div class="menu">
  <h1><a href="/">turtleblog</a></h1>
  <ul>
    <li><a href="/about.html">/about</a></li>
  </ul>
</div>

</header>

  <h1>Exploring Writing foldl Using foldr</h1>
  
  
  <time datetime="2016-01-27T08:00:00&#43;08:00">January 27, 2016</time>
  <p>It is widely known that left folding can be implemented by right folding.
But the implementation is not so obvious. Let&rsquo;s try writing one from scratch.
First, we need these two extensions of GHC to make life better.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-haskell" data-lang="haskell"><span style="display:flex;"><span><span style="font-style:italic">{-# LANGUAGE ScopedTypeVariables, PartialTypeSignatures #-}</span>
</span></span></code></pre></div><p>Let&rsquo;s just ignore the original implementations in <code>Prelude</code>
and try writing them by hand:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-haskell" data-lang="haskell"><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-weight:bold">Prelude</span> <span style="font-weight:bold">hiding</span> (foldr, foldl)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>foldr <span style="font-weight:bold">::</span> (b <span style="font-weight:bold">-&gt;</span> a <span style="font-weight:bold">-&gt;</span> a) <span style="font-weight:bold">-&gt;</span> a <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> a
</span></span><span style="display:flex;"><span>foldr <span style="font-weight:bold">_</span> r <span style="">[]</span> <span style="font-weight:bold">=</span> r
</span></span><span style="display:flex;"><span>foldr f r (x<span style="">:</span>xs) <span style="font-weight:bold">=</span> f x (foldr f r xs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>foldl <span style="font-weight:bold">::</span> (a <span style="font-weight:bold">-&gt;</span> b <span style="font-weight:bold">-&gt;</span> a) <span style="font-weight:bold">-&gt;</span> a <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> a
</span></span><span style="display:flex;"><span>foldl f r <span style="">[]</span> <span style="font-weight:bold">=</span> r
</span></span><span style="display:flex;"><span>foldl f a (x<span style="">:</span>xs) <span style="font-weight:bold">=</span> foldl f (f a x) xs
</span></span></code></pre></div><p>If we want to write <code>foldl</code> using <code>foldr</code>,
that defination should looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-haskell" data-lang="haskell"><span style="display:flex;"><span>foldl <span style="font-weight:bold">::</span> forall a b. (a <span style="font-weight:bold">-&gt;</span> b <span style="font-weight:bold">-&gt;</span> a) <span style="font-weight:bold">-&gt;</span> a <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> a
</span></span><span style="display:flex;"><span>foldl f i bs <span style="font-weight:bold">=</span> foldr undefined undefined undefined
</span></span></code></pre></div><p>The only thing we can be sure is that we will still be working on list <code>bs</code>.
So let&rsquo;s refine the above one with this observation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-haskell" data-lang="haskell"><span style="display:flex;"><span>foldl <span style="font-weight:bold">::</span> forall a b. (a <span style="font-weight:bold">-&gt;</span> b <span style="font-weight:bold">-&gt;</span> a) <span style="font-weight:bold">-&gt;</span> a <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> a
</span></span><span style="display:flex;"><span>foldl f i bs <span style="font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">let</span> fold <span style="font-weight:bold">::</span> <span style="font-weight:bold">_</span> <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">_</span> <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">_</span>
</span></span><span style="display:flex;"><span>      fold <span style="font-weight:bold">=</span> foldr
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">in</span>  fold undefined undefined bs
</span></span></code></pre></div><p>Let&rsquo;s think about a small example. According to our original implantation,
<code>foldl f i [b1, b2]</code> should be expanded into <code>f (f i b1) b2</code>
but the form in <code>foldr g j [b1, b2]</code> is <code>g b1 (b g2 j)</code>.
The most important step is the definition of <code>g</code> and <code>j</code>.
The function <code>g</code> should have type looks like <code>b -&gt; r -&gt; r</code> and
if the first parameter is <code>b1</code>, the second parameter (<code>r</code>) should
be able to use <code>f i b1</code> in itself to re-build the original <code>foldl</code> expansion.
That sounds like a continuation <code>a -&gt; r</code> instead of just <code>r</code>.
Let&rsquo;s try this idea:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-haskell" data-lang="haskell"><span style="display:flex;"><span>foldl <span style="font-weight:bold">::</span> forall a b. (a <span style="font-weight:bold">-&gt;</span> b <span style="font-weight:bold">-&gt;</span> a) <span style="font-weight:bold">-&gt;</span> a <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> a
</span></span><span style="display:flex;"><span>foldl f i bs <span style="font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">let</span> fold <span style="font-weight:bold">::</span> (b <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r) <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r)) <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r) <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r)
</span></span><span style="display:flex;"><span>      fold <span style="font-weight:bold">=</span> foldr
</span></span><span style="display:flex;"><span>      g <span style="font-weight:bold">::</span> b <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r) <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r)
</span></span><span style="display:flex;"><span>      g b1 cont <span style="font-weight:bold">=</span> cont (f i b1)
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">in</span>  fold g undefined bs
</span></span></code></pre></div><p>Bad thing happens.
We get two type errors because now <code>g</code> and <code>fold</code> are of type ending with <code>(a -&gt; r)</code>.
Let&rsquo;s look into them one by one.
For <code>g</code>, we are using a <code>b</code> to turn a continuation into another continuation.
So <code>g</code> actually need a extra parameter <code>a</code>.
And <code>fold</code> return a continuation and need an initial value <code>a</code> to get the final result.
Let&rsquo;s refine the signature and definition:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-haskell" data-lang="haskell"><span style="display:flex;"><span>foldl <span style="font-weight:bold">::</span> forall a b. (a <span style="font-weight:bold">-&gt;</span> b <span style="font-weight:bold">-&gt;</span> a) <span style="font-weight:bold">-&gt;</span> a <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> a
</span></span><span style="display:flex;"><span>foldl f i bs <span style="font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">let</span> fold <span style="font-weight:bold">::</span> (b <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r) <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r)) <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r) <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r)
</span></span><span style="display:flex;"><span>      fold <span style="font-weight:bold">=</span> foldr
</span></span><span style="display:flex;"><span>      g <span style="font-weight:bold">::</span> b <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r) <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r)
</span></span><span style="display:flex;"><span>      g b1 cont a <span style="font-weight:bold">=</span> cont (f i b1)
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">in</span>  fold g undefined bs undefined
</span></span></code></pre></div><p>Now our compiler warns us that <code>a</code> is not used.
According to its type, the only place to use it is where <code>i</code> is.
This makes sense because we are using the future result in our computation.
But where <code>i</code> should go? The only place seems to using it to complete our <code>fold</code>.
(I think this is the only tricky part and hope to find better thoughts on this in the future.)
Let&rsquo;s refine it again:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-haskell" data-lang="haskell"><span style="display:flex;"><span>foldl <span style="font-weight:bold">::</span> forall a b. (a <span style="font-weight:bold">-&gt;</span> b <span style="font-weight:bold">-&gt;</span> a) <span style="font-weight:bold">-&gt;</span> a <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> a
</span></span><span style="display:flex;"><span>foldl f i bs <span style="font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">let</span> fold <span style="font-weight:bold">::</span> (b <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r) <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r)) <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r) <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r)
</span></span><span style="display:flex;"><span>      fold <span style="font-weight:bold">=</span> foldr
</span></span><span style="display:flex;"><span>      g <span style="font-weight:bold">::</span> b <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r) <span style="font-weight:bold">-&gt;</span> (a <span style="font-weight:bold">-&gt;</span> r)
</span></span><span style="display:flex;"><span>      g b1 cont a <span style="font-weight:bold">=</span> cont (f a b1)
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">in</span>  fold g undefined bs i
</span></span></code></pre></div><p>We are almost done and only one <code>undefined</code> is left.
Notice that the final result is of type <code>r</code> but our target type is <code>a</code>.
That just means <code>r</code> is <code>a</code>.
So the only left <code>undefined</code> is of type <code>forall a. a -&gt; a</code>
and its only implantation is <code>id</code> according to parametricity.
This also fits our experience with continuation by finishing it with <code>\a -&gt; a</code>.
Our final version is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-haskell" data-lang="haskell"><span style="display:flex;"><span>foldl <span style="font-weight:bold">::</span> forall a b. (a <span style="font-weight:bold">-&gt;</span> b <span style="font-weight:bold">-&gt;</span> a) <span style="font-weight:bold">-&gt;</span> a <span style="font-weight:bold">-&gt;</span> [b] <span style="font-weight:bold">-&gt;</span> a
</span></span><span style="display:flex;"><span>foldl f i bs <span style="font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">let</span> g b1 cont a <span style="font-weight:bold">=</span> cont (f a b1)
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">in</span>  foldr g id bs i
</span></span></code></pre></div><p>It works!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-haskell" data-lang="haskell"><span style="display:flex;"><span>λ&gt; foldl (\r x <span style="font-weight:bold">-&gt;</span> r ++ [x]) [0 <span style="font-weight:bold">::</span> <span style="">Int</span>] [1 .. 10]
</span></span><span style="display:flex;"><span>[0,1,2,3,4,5,6,7,8,9,10]
</span></span></code></pre></div>
  <script>MathJax={"tex":{"inlineMath":[["$","$"],["\\(","\\)"]],"displayMath":[["$$","$$"],["\\[","\\]"]]}}</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  

<footer>
<a href="https://github.com/scturtle"><svg><use xlink:href="/icons.svg#github"></use></svg></a>
<a href="https://twitter.com/scturtle"><svg><use xlink:href="/icons.svg#twitter"></use></svg></a>
<a href="https://t.me/scturtle"><svg><use xlink:href="/icons.svg#telegram"></use></svg></a>
<a href="/feed.xml"><svg><use xlink:href="/icons.svg#rss"></use></svg></a>

</footer>
</main>
</body>
</html>
